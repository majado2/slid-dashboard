# دليل مبرمج لوحة التحكم (WebSocket عرض التتبع الحي)

## الهدف
استقبال التحديثات اللحظية للطلبات عبر WebSocket وعرضها في الداشبورد (خريطة/جدول)، مع إمكانية مراقبة حالة الطلب.

## مسار WebSocket
- `ws://<host>/ws/tracking-requests/{id}`
- الخادم يرسل `init` بالحالة الحالية والسجلات، ثم يبث `log_added` عند أي سجل جديد. الطلبات المغلقة تُرفض.

## رسائل من الخادم
- تهيئة:
```json
{
  "event": "init",
  "data": {
    "request": { ...تفاصيل الطلب... },
    "logs": [ ...السجلات الحالية... ]
  }
}
```
- سجل جديد:
```json
{ "event": "log_added", "data": { ...السجل... } }
```
- تحديث حالة (مثلاً عند إغلاق الطلب من الجوال):
```json
{ "event": "request_updated", "status": "done" }
```
- أخطاء:
```json
{ "event": "error", "message": "..." }
```

## خطوات الواجهة
1) عند فتح شاشة طلب تتبع: استدعِ `GET /api/tracking-requests/{id}/full` لتهيئة البيانات.
2) افتح WebSocket على `ws/.../{id}`:
   - عند `init`: حدّث تفاصيل الطلب وجدول/خريطة السجلات.
   - عند `log_added`: أضف نقطة جديدة للجدول/الخريطة فورياً.
   - عند `request_updated`: أغلق القناة في الواجهة وبيّن أن الطلب انتهى.
3) أظهر حالة الاتصال (Connected/Disconnected) وأعد المحاولة عند الفشل.

## ملاحظات
- CORS مفتوح في الـMVP.
- إذا استلمت `error` بأن الطلب مغلق، لا تفتح اتصالاً جديداً لنفس الطلب.
- لا توجد مصادقة حقيقية الآن؛ إذا أضفناها لاحقاً يمكن تمرير التوكن في الهيدر عند إنشاء السوكيت.
