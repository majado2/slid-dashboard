# سير عمل طلب التتبع عبر SMS + صفحة قبول الإحداثيات

هذا المستند يوضح تدفق الخدمة من لوحة التحكم حتى موافقة المستفيد على مشاركة الموقع وإرسال الإحداثيات.

## 1) إنشاء طلب تتبع من لوحة التحكم (قناة SMS)

- المسار: `POST /api/tracking-requests/sms`
- الجسم:
  ```json
  {
    "beneficiary_id": 2,
    "authority_id": 10,
    "channel": "SMS"
  }
  ```
- الناتج: سجل طلب تتبع جديد بحالة `new` مرتبط بالمستفيد والجهة.

## 2) إرسال رسالة SMS للمستفيد

- يتم إرسال رسالة تتضمن رابط صفحة القبول (سيزودكم المصمم بالشكل النهائي للرابط).
- الرابط يجب أن يحتوي برامتر الهوية الوطنية (أو request_id) حسب ما يطلبه سيرفر الـSMS/الواجهة. مثال توضيحي:
  ```
  https://consent.example.com/consent?national_id=1063640446&request_id=4
  ```
- أنت ترسل نفس الرابط بنفس البرامترات إلى رقم جوال المستفيد (الموجود لدينا في قاعدة البيانات).
- لاحقاً، سنضيف/نستهلك API خاص بالـSMS (سيتم تزويده لاحقاً) لإرسال الرسالة فعلياً من الخادم.

### قالب الرسالة المقترح (ثابت)

```
وردنا بلاغكم رقم ({REQUEST_CODE}) عبر منصة أبشر،

ونأمل منكم الدخول فورا عبر الرابط التالي

والسماح بتحديد موقعكم الجغرافي لتسريع

وصول فرق الطوارئ في أسرع وقت ممكن:
{TODAY}
{CONSENT_LINK}
مع تمنياتنا لكم بالسلامة
```

- `{REQUEST_CODE}`: رقم/معرّف الطلب (مثال: SL456 أو الـ`request_id`).
- `{TODAY}`: تاريخ اليوم (مثال: 2025-12-02).
- `{CONSENT_LINK}`: رابط القبول.

### شكل الرابط (منفصل عن لوحة التحكم)

- صفحة القبول منفصلة عن لوحة التحكم، مستضافة مثلاً على Netlify:  
  `https://slid-ksa.netlify.app/consent?request_id={REQUEST_ID}&national_id={NATIONAL_ID}`
- استبدل `{REQUEST_ID}` و `{NATIONAL_ID}` بقيم الطلب/المستفيد عند الإرسال.
- واجهة React في هذه الصفحة:
  1. تقرأ `request_id` و`national_id` من الـquery.
  2. تطلب إذن الموقع من المستخدم.
  3. ترسل الإحداثيات عبر `POST /api/location/consent/{national_id}`.
  4. (اختياري) تستخدم WebSocket `/ws/tracking-requests/{request_id}` للبث الحي.

## 3) صفحة القبول (React) على الرابط

- تقوم بقراءة البرامترات (`national_id` و/أو `request_id`).
- تطلب إذن الموقع من المستخدم.
- عند الحصول على الإحداثيات، ترسلها إلى API الـConsent لدينا:
  - `POST /api/location/consent/{national_id}`
  - الجسم:
    ```json
    {
      "latitude": 24.7136,
      "longitude": 46.6753,
      "accuracy_m": 5,
      "altitude_m": 612
    }
    ```
  - النتيجة: تفعيل المشاركة المكانية وتحديث الإحداثيات.

## 4) البدء في بث الإحداثيات (اختياري بعد القبول)

- إذا أردت إرسال أكثر من نقطة (تتبع حي)، استخدم WebSocket:
  - المسار: `/ws/tracking-requests/{request_id}`
  - أرسل حدث:
    ```json
    {
      "event": "location_update",
      "data": {
        "latitude": 24.7136,
        "longitude": 46.6753,
        "accuracy_m": 5,
        "altitude_m": 612,
        "captured_at": "2025-12-02T12:00:00Z"
      }
    }
    ```
  - إذا لم يتوفر WebSocket في الصفحة البسيطة، يمكن الاكتفاء بنقطة واحدة عبر الـConsent فقط.

## 5) عرض الطلب والسجلات في لوحة التحكم

- `GET /api/tracking-requests` لعرض الطلبات مع اسم المستفيد والجهة.
- `GET /api/tracking-requests/{id}/logs` أو `/full` لعرض السجلات وتفاصيل الطلب.
- WebSocket على `/ws/tracking-requests/{id}` لتحديث حي في واجهة اللوحة.

## نقاط تكامل الـSMS (Placeholder)

- سيتم تزويدنا بـAPI خاص بالـSMS (من مزود أو سيرفر خارجي).
- عند استلام تفاصيل API (URL/Headers/Body)، سنضيف استدعاء الإرسال بعد إنشاء الطلب في لوحة التحكم:
  - يأخذ رقم جوال المستفيد + رابط القبول (مع البرامترات المطلوبة).
  - يرسل النص المطلوب عبر الـSMS API.

## ملخص

- لوحة التحكم: تنشئ طلب قناة SMS ➜ نرسل SMS برابط القبول ➜ المستفيد يفتح الرابط ويرسل إحداثياته عبر `/api/location/consent/{national_id}` ➜ (اختياري) بث حي عبر WebSocket ➜ اللوحة تعرض السجلات والتحديثات.***
